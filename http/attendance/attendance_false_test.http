@baseUrl = http://localhost:8000
@classDate =
@period = 1
@teacher = 2


### 0. 관리자 로그인
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "admin@test.com",
  "password": "admin1234"
}

> {%
    client.global.set("admin_access_token", response.body.data.accessToken);
%}

### 0-1. 관리자 프로필 (userId)
GET {{baseUrl}}/user/me
Authorization: Bearer {{admin_access_token}}

> {%
    client.global.set("admin_id", response.body.data.userId);
%}

### 1. 과목 생성
POST {{baseUrl}}/subjects
Authorization: Bearer {{admin_access_token}}
Content-Type: application/json

{
  "name": "MATH"
}

> {%
    client.global.set("subject_id", response.body.data);
%}

### 2. 교사 등록
POST {{baseUrl}}/user/register
Authorization: Bearer {{admin_access_token}}
Content-Type: application/json

{
  "email": "teacher1@test.com",
  "password": "password1234!",
  "name": "교사1",
  "role": "TEACHER",
  "birthDate": "1990-01-01",
  "teacherDetail": {
    "subjectId": {{subject_id}},
    "subject": "MATH",
    "homeroomGrade": 1,
    "homeroomClass": 1
  }
}

> {%
    client.global.set("teacher_email", "teacher1@test.com");
    client.global.set("teacher_password", "password1234!");
    client.global.set("teacher_auth_code", "900101");
%}

### 3. 교사 계정 활성화
POST {{baseUrl}}/auth/activate
Content-Type: application/json

{
  "email": "{{teacher_email}}",
  "name": "교사1",
  "birthDate": "1990-01-01",
  "authCode": "{{teacher_auth_code}}",
  "newPassword": "{{teacher_password}}"
}

### 4. 교사 로그인
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{teacher_email}}",
  "password": "{{teacher_password}}"
}

> {%
    client.global.set("teacher_access_token", response.body.data.accessToken);
%}

### 4-1. 교사 프로필 (userId = teacherDetailId)
GET {{baseUrl}}/user/me
Authorization: Bearer {{teacher_access_token}}

> {%
    client.global.set("teacher_id", response.body.data.userId);
%}

### 5. 학생 등록
POST {{baseUrl}}/user/register
Authorization: Bearer {{admin_access_token}}
Content-Type: application/json

{
  "email": "student1@test.com",
  "password": "password1234!",
  "name": "학생1",
  "role": "STUDENT",
  "birthDate": "2005-01-01",
  "studentDetail": {
    "grade": 1,
    "classNo": "1",
    "studentNo": 1
  }
}

> {%
    client.global.set("student_email", "student1@test.com");
    client.global.set("student_password", "password1234!");
    client.global.set("student_auth_code", "050101");
%}

### 6. 학생 계정 활성화
POST {{baseUrl}}/auth/activate
Content-Type: application/json

{
  "email": "{{student_email}}",
  "name": "학생1",
  "birthDate": "2005-01-01",
  "authCode": "{{student_auth_code}}",
  "newPassword": "{{student_password}}"
}

### 7. 학생 로그인
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{student_email}}",
  "password": "{{student_password}}"
}

> {%
    client.global.set("student_access_token", response.body.data.accessToken);
%}

### 7-1. 학생 프로필 (userId)
GET {{baseUrl}}/user/me
Authorization: Bearer {{student_access_token}}

> {%
    client.global.set("student_id", response.body.data.userId);
%}

### 8. 학년도 생성
POST {{baseUrl}}/schedule/years
Authorization: Bearer {{admin_access_token}}
Content-Type: application/json

{
  "year": 2026,
  "semester": 1,
  "startDate": "2026-03-01",
  "endDate": "2026-06-30"
}

> {%
    client.global.set("academic_year_id", response.body.data);
%}

### 9. 강좌 개설 (교사)
POST {{baseUrl}}/courses
Authorization: Bearer {{teacher_access_token}}
Content-Type: application/json

{
  "name": "기초 수학",
  "courseType": "MANDATORY",
  "maxCapacity": 30,
  "tuition": 200000,
  "subjectId": {{subject_id}},
  "academicYearId": {{academic_year_id}},
  "teacherDetailId": {{teacher_id}},
  "timeSlots": [
    {
      "dayOfWeek": "MONDAY",
      "period": {{period}},
      "classroom": "101"
    }
  ]
}

### 9-1. 강좌 ID 조회 (교사 목록)
GET {{baseUrl}}/courses/teacher/{{teacher_id}}
Authorization: Bearer {{teacher_access_token}}

> {%
    client.global.set("course_id", response.body.data.content[0].courseId);
%}

### 9-2. 강좌 승인 (관리자)
POST {{baseUrl}}/courses/{{course_id}}/approve
Authorization: Bearer {{admin_access_token}}

### 10. 수강 신청
POST {{baseUrl}}/enrollments
Authorization: Bearer {{student_access_token}}
Content-Type: application/json

{
  "courseId": {{course_id}}
}

> {%
    client.global.set("enrollment_id", response.body.data);
%}

### 11. 출결 코드 조회 (활성)
GET {{baseUrl}}/attendance/codes?activeOnly=true
Authorization: Bearer {{teacher_access_token}}

> {%
    const codes = response.body.data || [];
    const present = codes.find(c => c.code === "PRESENT") || codes[0];
    const alt = codes.find(c => c.code !== present.code) || present;
    client.global.set("present_code_id", present.attendanceCodeId);
    client.global.set("alt_code_id", alt.attendanceCodeId);
%}

### 12. 출석부 자동 생성
POST {{baseUrl}}/attendance
Authorization: Bearer {{teacher_access_token}}
Content-Type: application/json

{
  "courseId": 1,
  "classDate": "2026-01-14",
  "period": 2,
  "userId": 2
}

### 13. 출결 저장
PATCH {{baseUrl}}/attendance
Authorization: Bearer {{teacher_access_token}}
Content-Type: application/json

{
  "courseId": 1,
  "classDate": "2026-01-14",
  "period": 2,
  "userId": 2,
  "items": [
    {
      "enrollmentId": 1,
      "attendanceCodeId": {{present_code_id}},
      "reason": "정상 출석"
    }
  ]
}

### 14. 출결 목록 조회
GET {{baseUrl}}/attendance?courseId={{course_id}}&fromDate={{classDate}}&toDate={{classDate}}&period={{period}}
Authorization: Bearer {{teacher_access_token}}

> {%
    client.global.set("attendance_id", response.body.data[0].attendanceId);
%}

### 15. 출결 확정 (담임)
POST {{baseUrl}}/attendance/confirmations
Authorization: Bearer {{teacher_access_token}}
Content-Type: application/json

{
  "courseId": 1,
  "classDate": "2026-01-14",
  "period": 2,
  "userId": 2
}

### 16. 정정 요청 생성
POST {{baseUrl}}/attendance/corrections
Authorization: Bearer {{teacher_access_token}}
Content-Type: application/json

{
  "attendanceId": {{attendance_id}},
  "requestedAttendanceCodeId": {{alt_code_id}},
  "requestReason": "정정 요청 테스트",
  "requestedBy": {{teacher_id}}
}

### 16-1. 정정 요청 조회
GET {{baseUrl}}/attendance/corrections?status=PENDING
Authorization: Bearer {{teacher_access_token}}

> {%
    client.global.set("correction_request_id", response.body.data[0].requestId);
%}

### 16-2. 정정 요청 처리 (관리자 승인)
PATCH {{baseUrl}}/attendance/corrections/{{correction_request_id}}
Authorization: Bearer {{admin_access_token}}
Content-Type: application/json

{
  "approved": true,
  "adminComment": "승인",
  "adminId": {{admin_id}}
}

### 16-3. 정정 요청 처리 (관리자 반려)
PATCH {{baseUrl}}/attendance/corrections/{{correction_request_id}}
Authorization: Bearer {{admin_access_token}}
Content-Type: application/json

{
  "approved": false,
  "adminComment": "반려",
  "adminId": {{admin_id}}
}

### 17. 출결 마감 (관리자, 월 단위)
POST {{baseUrl}}/attendance/closures
Authorization: Bearer {{admin_access_token}}
Content-Type: application/json

{
  "academicYearId": {{academic_year_id}},
  "scopeType": "MONTH",
  "scopeValue": "2026-01",
  "courseId": 1,
  "userId": {{admin_id}}
}

### 17-1. 마감 이력 조회
GET {{baseUrl}}/attendance/closures?courseId={{course_id}}
Authorization: Bearer {{admin_access_token}}

### 출결 확정 실패 (담임 권한 없음)
POST {{baseUrl}}/attendance/confirmations
Authorization: Bearer {{student_access_token}}
Content-Type: application/json

{
  "courseId": 1,
  "classDate": "2026-01-14",
  "period": 2,
  "userId": 1
}

### 정정 요청 처리 실패 (관리자 권한 없음)
PATCH {{baseUrl}}/attendance/corrections/{{correction_request_id}}
Authorization: Bearer {{teacher_access_token}}
Content-Type: application/json

{
  "approved": true,
  "adminComment": "승인",
  "adminId": {{teacher_id}}
}