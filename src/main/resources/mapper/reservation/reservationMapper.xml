<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.project.reservation.query.mapper.ReservationMapper">

    <!--  예약 가능 시설 조회 -->
    <select id="selectAvailableFacilities"
            resultType="com.mycompany.project.reservation.query.dto.FacilityDTO">

        SELECT
        f.facility_id AS facilityId,
        f.name        AS name,
        f.status      AS status
        FROM tbl_facility f

        LEFT JOIN tbl_reservation r
        ON r.facility_id = f.facility_id
        AND r.reservation_date = #{reservationDate}
        AND r.start_time = #{startTime}
        AND r.status IN ('WAITING', 'APPROVED')

        LEFT JOIN tbl_facility_restriction fr
        ON fr.facility_id = f.facility_id
        AND #{reservationDate} BETWEEN fr.start_date AND fr.end_date

        WHERE f.status = 'AVAILABLE'
        AND r.reservation_id IS NULL
        AND fr.restriction_id IS NULL
        AND #{startTime} >= f.open_time
        AND #{startTime} < f.close_time
        ORDER BY f.name

    </select>


    <!--  나의 예약 조회 -->
    <select id="selectMyReservations"
            resultType="com.mycompany.project.reservation.query.dto.ReservationDTO">
        SELECT
        r.reservation_id    AS reservationId,
        r.facility_id       AS facilityId,
        r.reservation_date  AS reservationDate,
        r.start_time        AS startTime,
        r.end_time          AS endTime,
        r.status            AS status,
        r.created_at        AS createdAt,
        r.rejection_reason  AS rejectionReason
        FROM tbl_reservation r
        WHERE r.student_id = #{studentId}
        <if test="status != null and status != ''">
            AND r.status = #{status}
        </if>
        ORDER BY r.reservation_date DESC, r.start_time DESC
    </select>


    <!-- 예약 목록 조회(관리자/전체 조회 용도로 쓰려면 조건 추가 필요) -->
    <select id="selectReservationList"
            resultType="com.mycompany.project.reservation.query.dto.ReservationDTO">
        SELECT
        r.reservation_id    AS reservationId,
        r.facility_id       AS facilityId,
        r.student_id        AS studentId,
        r.reservation_date  AS reservationDate,
        r.start_time        AS startTime,
        r.end_time          AS endTime,
        r.status            AS status,
        r.created_at        AS createdAt,
        r.rejection_reason  AS rejectionReason
        FROM tbl_reservation r
        WHERE 1=1
        <if test="studentId != null">
            AND r.student_id = #{studentId}
        </if>
        <if test="status != null and status != ''">
            AND r.status = #{status}
        </if>
        ORDER BY r.reservation_date DESC, r.start_time DESC
    </select>

    <select id="selectAdminReservationStatus"
            parameterType="map"
            resultType="com.mycompany.project.reservation.query.dto.ReservationDTO">

        SELECT
        r.reservation_id,
        r.facility_id,
        r.reservation_date,
        r.start_time,
        r.end_time,
        r.status,
        r.student_id
        FROM reservation r
        WHERE r.admin_id = #{adminId}
        AND r.reservation_date = #{reservationDate}
        AND r.status = #{status}
        ORDER BY r.start_time

    </select>
</mapper>