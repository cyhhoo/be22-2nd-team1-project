<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace: Mapper 인터페이스 풀패키지명과 동일해야 연결됨 -->
<mapper namespace="com.mycompany.project.attendance.mapper.AttendanceQueryMapper">

    <!-- 출결 상세 -->
    <select id="findById" parameterType="long"
            resultType="com.mycompany.project.attendance.dto.response.AttendanceResponse">
        SELECT
        -- AS 별칭은 "DTO 필드명"에 맞추는 게 핵심 (여기 틀리면 값이 안 들어감)
        a.attendance_id      AS attendanceId,
        a.class_date         AS classDate,
        a.period             AS period,
        a.reason             AS reason,
        a.state              AS state,
        a.saved_by           AS savedBy,
        a.saved_at           AS savedAt,
        a.confirmed_by       AS confirmedBy,
        a.confirmed_at       AS confirmedAt,
        a.closed_at          AS closedAt,
        a.attendance_code_id AS attendanceCodeId,
        ac.code              AS attendanceCode,
        ac.name              AS attendanceCodeName,
        a.enrollment_id      AS enrollmentId,
        a.created_at         AS createdAt,
        a.updated_at         AS updatedAt
        FROM tbl_attendance a
        -- 코드명(출석/지각/결석)을 같이 보여주고 싶어서 join
        JOIN tbl_attendance_code ac
        ON a.attendance_code_id = ac.attendance_code_id
        WHERE a.attendance_id = #{attendanceId}
    </select>

    <!-- 출결 목록/검색 -->
    <select id="search"
            parameterType="com.mycompany.project.attendance.dto.request.AttendanceSearchRequest"
            resultType="com.mycompany.project.attendance.dto.response.AttendanceListResponse">
        SELECT
        a.attendance_id      AS attendanceId,
        a.class_date         AS classDate,
        a.period             AS period,
        a.state              AS state,
        a.attendance_code_id AS attendanceCodeId,
        ac.name              AS attendanceCodeName,
        a.enrollment_id      AS enrollmentId,
        a.confirmed_at       AS confirmedAt,
        a.closed_at          AS closedAt
        FROM tbl_attendance a
        JOIN tbl_attendance_code ac
        ON a.attendance_code_id = ac.attendance_code_id
        JOIN tbl_enrollment e
        ON a.enrollment_id = e.enrollment_id

        <!-- where절을 동적으로 조립. 조건이 없으면 where 자체가 안 생김 -->
        <where>
            <if test="fromDate != null">
                a.class_date <![CDATA[ >= ]]> #{fromDate}
            </if>
            <if test="toDate != null">
                AND a.class_date <![CDATA[ <= ]]> #{toDate}
            </if>
            <if test="enrollmentId != null">
                AND a.enrollment_id = #{enrollmentId}
            </if>
            <if test="courseId != null">
                AND e.course_id = #{courseId}
            </if>
            <if test="attendanceCodeId != null">
                AND a.attendance_code_id = #{attendanceCodeId}
            </if>
            <if test="state != null">
                AND a.state = #{state}
            </if>
            <if test="period != null">
                AND a.period = #{period}
            </if>
        </where>

        <!-- 최신 날짜부터 보여주고, 같은 날이면 교시 오름차순 -->
        ORDER BY a.class_date DESC, a.period ASC

        <!-- limit/offset 둘 다 있을 때만 페이징 적용 -->
        <if test="limit != null and offset != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- 페이징 total count -->
    <select id="count"
            parameterType="com.mycompany.project.attendance.dto.request.AttendanceSearchRequest"
            resultType="long">
        SELECT COUNT(*)
        FROM tbl_attendance a
        JOIN tbl_enrollment e
        ON a.enrollment_id = e.enrollment_id
        <where>
            <if test="fromDate != null">
                a.class_date <![CDATA[ >= ]]> #{fromDate}
            </if>
            <if test="toDate != null">
                AND a.class_date <![CDATA[ <= ]]> #{toDate}
            </if>
            <if test="enrollmentId != null">
                AND a.enrollment_id = #{enrollmentId}
            </if>
            <if test="courseId != null">
                AND e.course_id = #{courseId}
            </if>
            <if test="attendanceCodeId != null">
                AND a.attendance_code_id = #{attendanceCodeId}
            </if>
            <if test="state != null">
                AND a.state = #{state}
            </if>
            <if test="period != null">
                AND a.period = #{period}
            </if>
        </where>
    </select>

</mapper>
