<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mycompany.project.attendance.query.repository.AttendanceCorrectionQueryMapper">

    <!-- Get single correction request detail -->
    <select id="findById" parameterType="long"
            resultType="com.mycompany.project.attendance.query.application.dto.CorrectionResponse">
        SELECT
        request_id                  AS requestId,
        attendance_id               AS attendanceId,
        before_attendance_code_id   AS beforeAttendanceCodeId,
        requested_attendance_code_id AS requestedAttendanceCodeId,
        request_reason              AS requestReason,
        status                      AS status,
        requested_by                AS requestedBy,
        requested_at                AS requestedAt,
        decided_by                  AS decidedBy,
        decided_at                  AS decidedAt,
        admin_comment               AS adminComment,
        pending_flag                AS pendingFlag
        FROM tbl_attendance_correction_request
        WHERE request_id = #{requestId}
    </select>

    <!-- Correction Request List/Search -->
    <select id="search"
            parameterType="com.mycompany.project.attendance.command.application.dto.CorrectionSearchRequest"
            resultType="com.mycompany.project.attendance.query.application.dto.CorrectionResponse">
        SELECT
        request_id                  AS requestId,
        attendance_id               AS attendanceId,
        before_attendance_code_id   AS beforeAttendanceCodeId,
        requested_attendance_code_id AS requestedAttendanceCodeId,
        request_reason              AS requestReason,
        status                      AS status,
        requested_by                AS requestedBy,
        requested_at                AS requestedAt,
        decided_by                  AS decidedBy,
        decided_at                  AS decidedAt,
        admin_comment               AS adminComment,
        pending_flag                AS pendingFlag
        FROM tbl_attendance_correction_request
        <where>
            <if test="attendanceId != null">
                attendance_id = #{attendanceId}
            </if>
            <if test="requestedBy != null">
                AND requested_by = #{requestedBy}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="fromDateTime != null">
                AND requested_at <![CDATA[ >= ]]> #{fromDateTime}
            </if>
            <if test="toDateTime != null">
                AND requested_at <![CDATA[ <= ]]> #{toDateTime}
            </if>
        </where>
        ORDER BY requested_at DESC, request_id DESC
        <if test="limit != null and offset != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Total count for pagination -->
    <select id="count"
            parameterType="com.mycompany.project.attendance.command.application.dto.CorrectionSearchRequest"
            resultType="long">
        SELECT COUNT(*)
        FROM tbl_attendance_correction_request
        <where>
            <if test="attendanceId != null">
                attendance_id = #{attendanceId}
            </if>
            <if test="requestedBy != null">
                AND requested_by = #{requestedBy}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="fromDateTime != null">
                AND requested_at <![CDATA[ >= ]]> #{fromDateTime}
            </if>
            <if test="toDateTime != null">
                AND requested_at <![CDATA[ <= ]]> #{toDateTime}
            </if>
        </where>
    </select>

</mapper>
