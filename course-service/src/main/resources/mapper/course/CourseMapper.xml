<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.project.course.query.repository.CourseMapper">

    <!-- 援먯궗 以묐났 ?ㅼ?以?議고쉶 (諛섎젮/?먭컯 ?쒖쇅) -->
    <select id="countTeacherSchedule" resultType="int">
        SELECT COUNT(*)
        FROM tbl_course c
        JOIN tbl_course_time_slot cts ON c.course_id = cts.course_id
        WHERE c.academic_year_id = #{academicYearId}
          AND c.teacher_detail_id = #{teacherDetailId}
          AND cts.day_of_week = #{dayOfWeek}
          AND cts.period = #{period}
          AND c.status NOT IN ('CANCELED', 'REFUSE')
    </select>

    <!-- 媛뺤쓽??以묐났 ?ㅼ?以?議고쉶 (諛섎젮/?먭컯 ?쒖쇅) -->
    <select id="countClassroomSchedule" resultType="int">
        SELECT COUNT(*)
        FROM tbl_course c
        JOIN tbl_course_time_slot cts ON c.course_id = cts.course_id
        WHERE c.academic_year_id = #{academicYearId}
          AND cts.classroom = #{classroom}
          AND cts.day_of_week = #{dayOfWeek}
          AND cts.period = #{period}
          AND c.status NOT IN ('CANCELED', 'REFUSE')
    </select>

    <!-- ?섍컯??以묐났 ?섍컯 ?댁뿭 議고쉶 (?먭컯/諛섎젮 ?쒖쇅) -->
    <select id="findConflictingEnrollments" resultType="java.util.Map">
        SELECT
            e.enrollment_id AS enrollmentId,
            c.course_id AS courseId,
            c.name AS courseName,
            c.course_type AS courseType
        FROM tbl_enrollment e
        JOIN tbl_course c ON e.course_id = c.course_id
        JOIN tbl_course_time_slot cts ON c.course_id = cts.course_id
        WHERE c.academic_year_id = #{academicYearId}
          AND e.user_id = #{studentId}
          AND cts.day_of_week = #{dayOfWeek}
          AND cts.period = #{period}
          AND e.status = 'APPLIED'
          AND c.status NOT IN ('CANCELED', 'REFUSE')
    </select>

    <!-- 援먯궗 二쇨컙 ?쒓컙??議고쉶 (?먭컯/諛섎젮 ?쒖쇅) -->
    <select id="findTeacherTimetable" resultType="java.util.Map">
        SELECT
            cts.day_of_week AS dayOfWeek,
            cts.period AS period,
            c.course_id AS courseId,
            c.name AS courseName,
            cts.classroom AS classroom,
            c.course_type AS courseType
        FROM tbl_course c
        JOIN tbl_course_time_slot cts ON c.course_id = cts.course_id
        WHERE c.academic_year_id = #{academicYearId}
          AND c.teacher_detail_id = #{teacherDetailId}
          AND c.status NOT IN ('CANCELED', 'REFUSE')
        ORDER BY
            CASE cts.day_of_week
                WHEN 'MON' THEN 1
                WHEN 'TUE' THEN 2
                WHEN 'WED' THEN 3
                WHEN 'THU' THEN 4
                WHEN 'FRI' THEN 5
                ELSE 6 END,
            cts.period
    </select>

</mapper>
