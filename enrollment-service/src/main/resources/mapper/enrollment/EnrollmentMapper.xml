<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mycompany.project.enrollment.command.domain.repository.EnrollmentMapper">

    <select id="selectTimetableByUserId"
            resultType="com.mycompany.project.enrollment.query.dto.TimetableResponse">
        SELECT
            c.course_id       AS courseId,
            c.name            AS courseName,
            cts.day_of_week   AS dayOfWeek,
            cts.period        AS period,
            cts.classroom     AS classroom,
            u_teacher.name    AS teacherName
        FROM
            tbl_enrollment e
                JOIN
            tbl_student_detail sd ON e.student_detail_id = sd.student_id
                JOIN
            tbl_course c ON e.course = c.course_id
                JOIN
            tbl_course_time_slot cts ON c.course_id = cts.course_id
                LEFT JOIN
            tbl_teacher_detail td ON c.teacher_detail_id = td.teacher_id
                LEFT JOIN
            tbl_user u_teacher ON td.teacher_id = u_teacher.user_id
        WHERE
            sd.student_id = #{userId}
          AND e.status = 'APPLIED'
        ORDER BY
            CASE cts.day_of_week
                WHEN 'MON' THEN 1
                WHEN 'TUE' THEN 2
                WHEN 'WED' THEN 3
                WHEN 'THU' THEN 4
                WHEN 'FRI' THEN 5
                WHEN 'SAT' THEN 6
                ELSE 7
                END ASC,
            cts.period ASC
    </select>

    <select id="selectHistoryByUserId"
            resultType="com.mycompany.project.enrollment.query.dto.EnrollmentHistoryResponse">
        SELECT
            e.enrollment_id   AS enrollmentId,
            c.course_id       AS courseId,
            c.name            AS courseName,
            u_teacher.name    AS teacherName,
            e.status          AS status,
            DATE_FORMAT(e.created_at, '%Y-%m-%d %H:%i') AS enrollmentDate
        FROM
            tbl_enrollment e
                JOIN
            tbl_student_detail sd ON e.student_detail_id = sd.student_id
                JOIN
            tbl_course c ON e.course = c.course_id
                LEFT JOIN
            tbl_teacher_detail td ON c.teacher_detail_id = td.teacher_id
                LEFT JOIN
            tbl_user u_teacher ON td.teacher_id = u_teacher.user_id
        WHERE
            sd.student_id = #{userId}
        ORDER BY
            e.created_at DESC
    </select>

    <!-- Additional Queries -->
    <select id="selectByCourseIdsAndStatus" resultMap="EnrollmentResultMap">
        SELECT
        enrollment_id,
        student_detail_id,
        course,
        status,
        created_at,
        updated_at
        FROM tbl_enrollment
        WHERE course IN
        <foreach item="id" collection="courseIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = #{status}
    </select>

    <resultMap id="EnrollmentResultMap" type="com.mycompany.project.enrollment.command.domain.aggregate.Enrollment">
        <id property="enrollmentId" column="enrollment_id"/>
        <result property="status" column="status"/>
    </resultMap>

</mapper>
